---
apiVersion: v1
kind: ConfigMap
metadata:
  name: capacity-fishing-script
  namespace: capacity-fishing
data:
  deploy.sh: |
    #!/usr/bin/env bash
    set -euo pipefail

    # Configuration
    SUBSCRIPTION_ID="${AZURE_SUBSCRIPTION_ID}"
    RESOURCE_GROUP="${AZURE_RESOURCE_GROUP}"
    TEMPLATE_FILE="/deployment/deployment.json"
    DEPLOYMENT_NAME="capacity-reservation-$(date +%Y%m%d-%H%M%S)"

    # Colors for output
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'

    echo "Logging in with Service Principal..."
    az login --service-principal \
      --username "$AZURE_CLIENT_ID" \
      --password "$AZURE_CLIENT_SECRET" \
      --tenant "$AZURE_TENANT_ID" \
      --only-show-errors

    echo "Setting subscription..."
    az account set --subscription "$SUBSCRIPTION_ID"

    echo -e "${YELLOW}Attempting deployment at $(date)${NC}"
    echo "Deploying capacity reservation group..."

    if az deployment group create \
      --name "$DEPLOYMENT_NAME" \
      --resource-group "$RESOURCE_GROUP" \
      --template-file "$TEMPLATE_FILE" \
      --only-show-errors; then

      echo -e "${GREEN}Deployment completed successfully!${NC}"
      echo "Suspend the CronJob to stop further attempts"
    else
      exit_code=$?
      echo -e "${RED}Deployment failed with exit code: ${exit_code}${NC}"
      echo "CronJob will retry on next schedule"
    fi

    exit 0
